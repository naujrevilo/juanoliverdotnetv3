---
import Layout from "../layouts/Layout.astro";
import PageHero from "../components/PageHero.astro";
import StoreList from "../components/StoreList.svelte";
import StoreFilters from "../components/StoreFilters.svelte";
import CartWidget from "../components/CartWidget.svelte";
import CartModal from "../components/CartModal.svelte";
import { getAllProducts, type Product } from "../services/products";
import servicesData from "../data/services.json";

// Force dynamic rendering for the store to fetch latest prices/stock
export const prerender = false;

const search = Astro.url.searchParams.get("search") || "";
const category = Astro.url.searchParams.get("category") || "";
const page = parseInt(Astro.url.searchParams.get("page") || "1");

// Obtener servicios disponibles (que no requieren plataforma)
const { services, categories } = servicesData;
const availableServices = services.filter(
  (service) => !service.requiresPlatform
);

// Convertir servicios al formato de producto para el carrito
// Usamos as Product[] porque los servicios tienen estructura compatible
const serviceProducts = availableServices.map((service) => ({
  id: service.id,
  name: service.title,
  description: service.shortDescription,
  price: service.pricing?.basePrice || 0,
  imageUrl: null,
  brand:
    categories[service.category as keyof typeof categories]?.title ||
    "Servicio",
  model: service.code || null,
  category: "Servicios",
  externalProductId: service.id,
  source: "local" as const,
  stock: 999,
  slug: service.id,
  createdAt: null,
  icon: service.icon, // <-- icono personalizado
})) as Product[];

let productList: Product[] = [];
let totalPages = 0;
let currentPage = 1;
let error = null;

try {
  const result = await getAllProducts({ search, category, page });
  productList = result.products;
  totalPages = result.totalPages;
  currentPage = result.currentPage;
} catch (e) {
  console.error("Error fetching products:", e);
  error = "No se pudo conectar con el inventario completo.";
}

// Combinar productos y servicios, filtrando por búsqueda si aplica
let allProducts = [...serviceProducts, ...productList];
if (search) {
  const searchLower = search.toLowerCase();
  allProducts = allProducts.filter(
    (p) =>
      p.name.toLowerCase().includes(searchLower) ||
      p.description?.toLowerCase().includes(searchLower)
  );
}
if (category === "Servicios") {
  allProducts = serviceProducts;
} else if (category && category !== "Servicios") {
  allProducts = productList.filter((p) => p.category === category);
}
---

<Layout title="Tienda | Juan Oliver" fullWidth={true}>
  <PageHero
    title="Tienda Profesional"
    subtitle="Productos y servicios de ciberseguridad, infraestructura y tecnología empresarial"
    badge={{ text: "Catálogo de Productos y Servicios" }}
  />

  <div class="max-w-7xl mx-auto px-4 pb-20 relative mt-16">
    <!-- Background Decoration -->
    <div
      class="absolute -top-20 right-0 w-64 h-64 bg-security-blue/5 rounded-full blur-3xl -z-10"
    >
    </div>

    <div
      class="flex flex-col md:flex-row justify-between items-center mb-12 gap-4 animate-fade-in-up"
    >
      <div class="w-full md:w-auto">
        <StoreFilters
          client:only="svelte"
          search={search}
          category={category}
        />
      </div>
      <div
        class="inline-flex items-center gap-2 text-sm font-bold text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-5 py-2.5 rounded-full shadow-sm"
      >
        <svg
          class="w-4 h-4 text-security-blue"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm6 7a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1zm-3 3a1 1 0 100 2h.01a1 1 0 100-2H10zm-4 1a1 1 0 011-1h.01a1 1 0 110 2H7a1 1 0 01-1-1zm1-4a1 1 0 100 2h.01a1 1 0 100-2H7zm2 1a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm4-4a1 1 0 100 2h.01a1 1 0 100-2H13zM9 9a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zM7 8a1 1 0 000 2h.01a1 1 0 000-2H7z"
            clip-rule="evenodd"></path>
        </svg>
        Página {currentPage} de {totalPages || 1}
      </div>
    </div>

    {
      error && (
        <div class="glass-card border-l-4 border-red-500 p-4 mb-8" role="alert">
          <div class="flex">
            <div class="shrink-0">
              <svg
                class="h-5 w-5 text-red-400"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-red-700 dark:text-red-200">{error}</p>
            </div>
          </div>
        </div>
      )
    }

    <!-- Debug Info (Remove in production) -->
    <!-- <div class="bg-yellow-100 text-yellow-800 p-2 mb-4 text-xs">
            Products found: {productList.length}
        </div> -->

    <div>
      <StoreList client:only="svelte" products={allProducts} />
    </div>

    <!-- Pagination Controls -->
    {
      totalPages > 1 && (
        <div class="flex justify-center gap-4 mt-16 animate-fade-in-up">
          <a
            href={`?search=${search}&category=${category}&page=${currentPage - 1}`}
            class={`inline-flex items-center px-8 py-4 rounded-2xl text-sm font-bold shadow-lg transition-all duration-300 ${currentPage <= 1 ? "pointer-events-none opacity-40 bg-slate-100 dark:bg-slate-800 text-slate-400 cursor-not-allowed" : "glass-card border-2 border-slate-200 dark:border-slate-700 hover:border-security-blue/50 text-slate-700 dark:text-white hover:-translate-y-1 hover:shadow-xl card-hover-lift"}`}
          >
            <svg
              class="mr-2 h-5 w-5"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6" />
            </svg>
            Anterior
          </a>

          <a
            href={`?search=${search}&category=${category}&page=${currentPage + 1}`}
            class={`inline-flex items-center px-8 py-4 rounded-2xl text-sm font-bold shadow-lg transition-all duration-300 ${currentPage >= totalPages ? "pointer-events-none opacity-40 bg-slate-100 dark:bg-slate-800 text-slate-400 cursor-not-allowed" : "glass-card border-2 border-slate-200 dark:border-slate-700 hover:border-security-blue/50 text-slate-700 dark:text-white hover:-translate-y-1 hover:shadow-xl card-hover-lift"}`}
          >
            Siguiente
            <svg
              class="ml-2 h-5 w-5"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </a>
        </div>
      )
    }
  </div>

  <!-- Cart Components (A/B Testing) -->
  <CartWidget client:only="svelte" />
  <CartModal client:only="svelte" />
</Layout>
